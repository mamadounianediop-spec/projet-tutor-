{% extends "base.html" %}

{% block title %}Personnel - IEF Louga{% endblock %}

{% block extra_css %}
<style>
    .personnel-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .personnel-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #3b82f6, #1e40af);
    }
    
    .personnel-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 35px rgba(0,0,0,0.1);
    }
    
    .gender-card-male {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%    personnelCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Initialisation du graphique des corps
    initCorpsChart();
});

function initCorpsChart() {
    const ctx = document.getElementById('corpsChart');
    if (!ctx) return;
    
    const ctxChart = ctx.getContext('2d');
    
    // Données du graphique
    const corpsData = [
        {% for corps in stats.par_corps %}
        {
            label: '{{ corps.corps }}',
            value: {{ corps.count }},
            color: `hsl({{ loop.index0 * 45 % 360 }}, 70%, 60%)`
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Configuration Chart.js
    new Chart(ctxChart, {
        type: 'doughnut',
        data: {
            labels: corpsData.map(d => d.label),
            datasets: [{
                data: corpsData.map(d => d.value),
                backgroundColor: corpsData.map(d => d.color),
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });   border: 1px solid #60a5fa;
    }
    
    .gender-card-female {
        background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
        border: 1px solid #f472b6;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .status-affecte { 
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
        color: #065f46; 
        border: 1px solid #34d399;
    }
    
    .status-non-affecte { 
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
        color: #991b1b; 
        border: 1px solid #f87171;
    }
    
    .profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        text-transform: uppercase;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .corps-badge {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #374151;
        border: 1px solid #d1d5db;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .filter-advanced {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .filter-advanced:hover {
        border-color: #3b82f6;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
    }
    
    .progress-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1e40af);
        border-radius: 4px;
        transition: width 0.6s ease;
    }
    
    .analytics-widget {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .analytics-widget:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-users mr-3 text-blue-600"></i>
                    Personnel Éducatif IEF Louga
                </h1>
                <p class="text-gray-600 mt-1">Gestion et analyse professionnelle des ressources humaines</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3 text-sm text-gray-500">
                    <div class="flex items-center">
                        <i class="fas fa-users mr-1 text-blue-600"></i>
                        <span class="font-bold text-blue-600">{{ stats.total_personnel }}</span>
                        <span class="ml-1">agents</span>
                    </div>
                    <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                    <div class="flex items-center">
                        <i class="fas fa-venus-mars mr-1 text-purple-600"></i>
                        <span class="font-bold text-blue-600">{{ stats.personnel_hommes }}</span>H /
                        <span class="font-bold text-pink-600">{{ stats.personnel_femmes }}</span>F
                    </div>
                    <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                    <div class="flex items-center">
                        <i class="fas fa-percentage mr-1 text-green-600"></i>
                        <span class="font-bold text-green-600">{{ stats.personnel_affecte | format_percentage(stats.total_personnel) }}%</span>
                        <span class="ml-1">affectés</span>
                    </div>
                </div>
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                    <i class="fas fa-user-plus mr-2"></i>
                    Nouveau Personnel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Métriques RH Avancées -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Personnel par Statut d'Affectation -->
        <div class="personnel-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Personnel Affecté</p>
                    <p class="text-3xl font-bold text-green-700 mt-2">{{ stats.personnel_affecte | format_number }}</p>
                    <div class="flex items-center mt-2 text-sm">
                        <span class="text-green-600 font-medium">{{ (stats.personnel_affecte / stats.total_personnel * 100) | round(1) }}%</span>
                        <span class="text-gray-500 ml-1">du total</span>
                    </div>
                </div>
                <div class="p-4 bg-green-100 rounded-xl">
                    <i class="fas fa-user-check text-green-600 text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 bg-green-50 rounded-lg p-3">
                <div class="flex items-center justify-between text-xs">
                    <span class="text-green-700">Non affectés</span>
                    <span class="text-green-800 font-bold">{{ stats.personnel_non_affecte }}</span>
                </div>
            </div>
        </div>

        <!-- Personnel par Corps Principal -->
        <div class="personnel-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Corps Principaux</p>
                    <div class="mt-2">
                        {% if stats.par_corps %}
                            {% for corps in stats.par_corps[:2] %}
                            <div class="flex justify-between items-center text-sm mb-1">
                                <span class="text-gray-700 font-medium">{{ corps.corps[:15] }}</span>
                                <span class="text-blue-600 font-bold">{{ corps.count }}</span>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                <div class="p-4 bg-blue-100 rounded-xl">
                    <i class="fas fa-graduation-cap text-blue-600 text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 bg-blue-50 rounded-lg p-3">
                <div class="flex items-center justify-between text-xs">
                    <span class="text-blue-700">Total corps différents</span>
                    <span class="text-blue-800 font-bold">{{ stats.par_corps | length }}</span>
                </div>
            </div>
        </div>

        <!-- Répartition par Genre -->
        <div class="personnel-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Répartition H/F</p>
                    <div class="flex items-center space-x-3 mt-2">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-700">{{ stats.personnel_hommes | format_number }}</p>
                            <p class="text-xs text-blue-600">Hommes</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-pink-700">{{ stats.personnel_femmes | format_number }}</p>
                            <p class="text-xs text-pink-600">Femmes</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-purple-100 rounded-xl">
                    <i class="fas fa-venus-mars text-purple-600 text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 bg-purple-50 rounded-lg p-3">
                <div class="flex items-center justify-between text-xs">
                    <span class="text-purple-700">Taux de féminisation</span>
                    <span class="text-purple-800 font-bold">{{ (stats.personnel_femmes / stats.total_personnel * 100) | round(1) }}%</span>
                </div>
            </div>
        </div>

        <!-- Personnel par Grade -->
        <div class="personnel-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Grades Principaux</p>
                    <div class="mt-2">
                        {% if stats.par_grade %}
                            {% for grade in stats.par_grade[:2] %}
                            <div class="flex justify-between items-center text-sm mb-1">
                                <span class="text-gray-700 font-medium">{{ grade.grade[:12] }}</span>
                                <span class="text-orange-600 font-bold">{{ grade.count }}</span>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                <div class="p-4 bg-orange-100 rounded-xl">
                    <i class="fas fa-award text-orange-600 text-2xl"></i>
                </div>
            </div>
            <div class="mt-4 bg-orange-50 rounded-lg p-3">
                <div class="flex items-center justify-between text-xs">
                    <span class="text-orange-700">Total grades différents</span>
                    <span class="text-orange-800 font-bold">{{ stats.par_grade | length }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres Avancés -->
    <div class="filter-advanced p-6 mb-8">
        <div class="border-b border-gray-200 pb-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-search-plus mr-3 text-blue-600"></i>
                Recherche et Filtres Avancés
            </h3>
            <p class="text-sm text-gray-600 mt-1">Utilisez les filtres pour analyser votre personnel selon différents critères</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Recherche Globale</label>
                <div class="relative">
                    <input type="text" id="search" placeholder="Nom, prénom, matricule..." 
                           class="w-full px-4 py-3 pl-10 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Corps</label>
                <select id="corps-filter" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="">👥 Tous les corps</option>
                    {% for corps in corps_list %}
                    <option value="{{ corps.corps }}">{{ corps.corps }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fonction</label>
                <select id="fonction-filter" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="">💼 Toutes les fonctions</option>
                    {% for fonction in fonctions_list %}
                    <option value="{{ fonction.fonction }}">{{ fonction.fonction }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Genre</label>
                <select id="genre-filter" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="">⚧ Tous les genres</option>
                    <option value="M">👨 Masculin</option>
                    <option value="F">👩 Féminin</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                <select id="statut-filter" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="">📊 Tous les statuts</option>
                    <option value="affecte">✅ Affectés</option>
                    <option value="non_affecte">❌ Non affectés</option>
                </select>
            </div>
        </div>
        
        <div class="mt-6 flex flex-wrap gap-3">
            <button onclick="applyFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors flex items-center">
                <i class="fas fa-search mr-2"></i>
                Rechercher
            </button>
            <button onclick="resetFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors flex items-center">
                <i class="fas fa-times mr-2"></i>
                Réinitialiser
            </button>
            <button onclick="exportPersonnel()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors flex items-center">
                <i class="fas fa-file-excel mr-2"></i>
                Export Excel
            </button>
            <button onclick="generateAnalytics()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors flex items-center">
                <i class="fas fa-chart-bar mr-2"></i>
                Analyses RH
            </button>
            <button onclick="showNonAffectes()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Non Affectés ({{ stats.personnel_non_affecte }})
            </button>
        </div>
    </div>

    <!-- Tableau Personnel Professionnel -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-address-book mr-3 text-blue-600"></i>
                        Répertoire du Personnel
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">
                        <span id="personnel-count" class="font-bold text-blue-600">{{ personnel|length }}</span> 
                        agents trouvés
                        <span class="text-gray-400 mx-2">•</span>
                        <span class="text-blue-600 font-medium">{{ stats.personnel_hommes }}</span> hommes
                        <span class="text-gray-400 mx-1">•</span>
                        <span class="text-pink-600 font-medium">{{ stats.personnel_femmes }}</span> femmes
                        <span class="text-gray-400 mx-2">•</span>
                        <span class="text-green-600 font-medium">{{ stats.personnel_affecte }}</span> affectés
                    </p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">Affichage:</span>
                        <select class="text-sm border border-gray-300 rounded-lg px-3 py-1 focus:outline-none focus:border-blue-500">
                            <option>25 par page</option>
                            <option>50 par page</option>
                            <option>100 par page</option>
                            <option>Tous</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button class="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center transition-colors" title="Vue liste">
                            <i class="fas fa-list text-sm"></i>
                        </button>
                        <button class="w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-600 flex items-center justify-center transition-colors" title="Vue cartes">
                            <i class="fas fa-th text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="personnel-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <div class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors">
                                <span>Agent</span>
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <div class="flex items-center space-x-2 cursor-pointer hover:text-blue-600 transition-colors">
                                <span>Corps & Fonction</span>
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Affectation</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="personnel-tbody">
                    {% for agent in personnel %}
                    <tr class="hover:bg-gray-50 transition-colors duration-150 border-l-4 border-transparent hover:border-blue-500">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="profile-avatar mr-4" style="background: {% if agent.sexe == 'F' %}linear-gradient(135deg, #ec4899, #be185d){% else %}linear-gradient(135deg, #3b82f6, #1e40af){% endif %}">
                                    {{ (agent.prenom[:1] + agent.nom[:1]) if agent.prenom and agent.nom else 'NA' }}
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-900">
                                        {{ agent.prenom or '' }} {{ agent.nom or 'Nom non défini' }}
                                    </div>
                                    {% if agent.matricule %}
                                    <div class="text-xs text-gray-500 flex items-center mt-1">
                                        <i class="fas fa-id-card mr-1"></i>
                                        Mat: {{ agent.matricule }}
                                    </div>
                                    {% endif %}
                                    <div class="flex items-center mt-1">
                                        {% if agent.sexe == 'F' %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-pink-100 text-pink-800">
                                            <i class="fas fa-female mr-1"></i>
                                            Féminin
                                        </span>
                                        {% elif agent.sexe == 'M' %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                            <i class="fas fa-male mr-1"></i>
                                            Masculin
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="space-y-2">
                                {% if agent.corps %}
                                <div class="corps-badge">
                                    <i class="fas fa-graduation-cap mr-1"></i>
                                    {{ agent.corps }}
                                </div>
                                {% endif %}
                                {% if agent.fonction %}
                                <div class="text-sm text-gray-700 font-medium">
                                    <i class="fas fa-briefcase mr-1 text-gray-400"></i>
                                    {{ agent.fonction }}
                                </div>
                                {% endif %}
                                {% if agent.grade %}
                                <div class="text-xs text-gray-500">
                                    Grade: {{ agent.grade }}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            {% if agent.etablissement_nom %}
                            <div class="flex items-start space-x-2">
                                <div class="p-2 bg-green-100 rounded-lg">
                                    <i class="fas fa-school text-green-600 text-sm"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ agent.etablissement_nom }}</div>
                                    {% if agent.commune_nom %}
                                    <div class="text-xs text-gray-500 flex items-center mt-1">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        {{ agent.commune_nom }}
                                    </div>
                                    {% endif %}
                                    <div class="status-badge status-affecte mt-1">
                                        <i class="fas fa-check mr-1"></i>
                                        Affecté
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="flex items-center space-x-2">
                                <div class="p-2 bg-red-100 rounded-lg">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-sm"></i>
                                </div>
                                <div>
                                    <div class="status-badge status-non-affecte">
                                        <i class="fas fa-times mr-1"></i>
                                        Non affecté
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Besoin d'affectation</div>
                                </div>
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="space-y-1">
                                {% if agent.telephone %}
                                <div class="text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-phone mr-2 text-green-500"></i>
                                    {{ agent.telephone }}
                                </div>
                                {% endif %}
                                {% if agent.email %}
                                <div class="text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-envelope mr-2 text-blue-500"></i>
                                    {{ agent.email }}
                                </div>
                                {% endif %}
                                {% if not agent.telephone and not agent.email %}
                                <div class="text-xs text-gray-400">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    Contact manquant
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            {% set score = 85 if agent.etablissement_nom else 30 %}
                            <div class="flex items-center space-x-2">
                                {% if score > 70 %}
                                <div class="status-badge bg-green-100 text-green-800">
                                    <i class="fas fa-star mr-1"></i>
                                    Excellent
                                </div>
                                {% elif score > 50 %}
                                <div class="status-badge bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-star-half-alt mr-1"></i>
                                    Moyen
                                </div>
                                {% else %}
                                <div class="status-badge bg-red-100 text-red-800">
                                    <i class="fas fa-exclamation mr-1"></i>
                                    À améliorer
                                </div>
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{ score }}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">Score: {{ score }}%</div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewProfile('{{ agent.id }}')" 
                                        class="w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-600 flex items-center justify-center transition-colors"
                                        title="Voir le profil">
                                    <i class="fas fa-user text-sm"></i>
                                </button>
                                <button onclick="editAgent('{{ agent.id }}')" 
                                        class="w-8 h-8 rounded-lg bg-green-100 hover:bg-green-200 text-green-600 flex items-center justify-center transition-colors"
                                        title="Modifier">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                {% if not agent.etablissement_nom %}
                                <button onclick="affectAgent('{{ agent.id }}')" 
                                        class="w-8 h-8 rounded-lg bg-purple-100 hover:bg-purple-200 text-purple-600 flex items-center justify-center transition-colors"
                                        title="Affecter">
                                    <i class="fas fa-plus text-sm"></i>
                                </button>
                                {% endif %}
                                <button onclick="generateFiche('{{ agent.id }}')" 
                                        class="w-8 h-8 rounded-lg bg-orange-100 hover:bg-orange-200 text-orange-600 flex items-center justify-center transition-colors"
                                        title="Fiche agent">
                                    <i class="fas fa-file-alt text-sm"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex-1 flex justify-between sm:hidden">
                    {% if pagination.has_prev %}
                        <a href="{{ url_for('personnel.index', page=pagination.prev_num, search=filters.search, corps=filters.corps, grade=filters.grade, genre=filters.genre, etablissement_id=filters.etablissement_id) }}" 
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                           Précédent
                        </a>
                    {% endif %}
                    {% if pagination.has_next %}
                        <a href="{{ url_for('personnel.index', page=pagination.next_num, search=filters.search, corps=filters.corps, grade=filters.grade, genre=filters.genre, etablissement_id=filters.etablissement_id) }}" 
                           class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                           Suivant
                        </a>
                    {% endif %}
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Affichage de <span class="font-medium text-blue-600">{{ (pagination.page - 1) * pagination.per_page + 1 }}</span> à 
                            <span class="font-medium text-blue-600">{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page <= pagination.total else pagination.total }}</span> 
                            sur <span class="font-medium text-blue-600">{{ pagination.total }}</span> résultats
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            {% if pagination.has_prev %}
                                <a href="{{ url_for('personnel.index', page=pagination.prev_num, search=filters.search, corps=filters.corps, grade=filters.grade, genre=filters.genre, etablissement_id=filters.etablissement_id) }}" 
                                   class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            {% endif %}
                            
                            {% for page_num in pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != pagination.page %}
                                        <a href="{{ url_for('personnel.index', page=page_num, search=filters.search, corps=filters.corps, grade=filters.grade, genre=filters.genre, etablissement_id=filters.etablissement_id) }}" 
                                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                           {{ page_num }}
                                        </a>
                                    {% else %}
                                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-600 text-sm font-medium text-white">
                                            {{ page_num }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500">
                                        ...
                                    </span>
                                {% endif %}
                            {% endfor %}
                            
                            {% if pagination.has_next %}
                                <a href="{{ url_for('personnel.index', page=pagination.next_num, search=filters.search, corps=filters.corps, grade=filters.grade, genre=filters.genre, etablissement_id=filters.etablissement_id) }}" 
                                   class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            {% endif %}
                        </nav>
                    </div>
            </div>
        </div>
    </div>
    
    <!-- Section Analyse par Corps avec Diagrammes -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-8">
        <div class="p-6 border-b border-gray-200 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-chart-pie mr-3 text-purple-600"></i>
                Personnel par Corps
            </h3>
            <p class="text-sm text-gray-600 mt-1">Analyse de la répartition du personnel selon les corps d'appartenance</p>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Graphique en camembert -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-md font-medium text-gray-800 mb-4">Répartition par Corps</h4>
                    <canvas id="corpsChart" width="300" height="300"></canvas>
                </div>
                
                <!-- Liste détaillée -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-md font-medium text-gray-800 mb-4">Détail par Corps</h4>
                    <div class="space-y-3 max-h-80 overflow-y-auto">
                        {% for corps in stats.par_corps %}
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">{{ corps.corps }}</div>
                                <div class="text-sm text-gray-600">
                                    {{ corps.hommes }} hommes • {{ corps.femmes }} femmes
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-blue-600">{{ corps.count }}</div>
                                <div class="text-xs text-gray-500">{{ (corps.count / stats.total_personnel * 100) | round(1) }}%</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let currentFilters = {};

function applyFilters() {
    const search = document.getElementById('search').value;
    const corps = document.getElementById('corps-filter').value;
    const fonction = document.getElementById('fonction-filter').value;
    const genre = document.getElementById('genre-filter').value;
    const statut = document.getElementById('statut-filter').value;
    
    currentFilters = { search, corps, fonction, genre, statut };
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (corps) params.append('corps', corps);
    if (fonction) params.append('fonction', fonction);
    if (genre) params.append('sexe', genre);
    if (statut) params.append('statut', statut);
    
    showLoadingAnimation();
    setTimeout(() => {
        window.location.href = '/personnel/?' + params.toString();
    }, 500);
}

function resetFilters() {
    showLoadingAnimation();
    setTimeout(() => {
        window.location.href = '/personnel/';
    }, 300);
}

function exportPersonnel() {
    const params = new URLSearchParams(window.location.search);
    params.append('export', 'excel');
    
    showNotification('Export en cours...', 'info');
    window.location.href = '/api/personnel/export?' + params.toString();
}

function generateAnalytics() {
    showNotification('Génération des analyses...', 'info');
    window.open('/personnel/analytics', '_blank');
}

function showNonAffectes() {
    window.location.href = '/personnel/?statut=non_affecte';
}

function viewProfile(agentId) {
    window.open(`/personnel/${agentId}`, '_blank');
}

function editAgent(agentId) {
    window.location.href = `/personnel/${agentId}/edit`;
}

function affectAgent(agentId) {
    showNotification('Module d\'affectation en cours de développement', 'info');
    // window.location.href = `/personnel/${agentId}/affecter`;
}

function generateFiche(agentId) {
    window.open(`/personnel/${agentId}/fiche`, '_blank');
}

function showLoadingAnimation() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Chargement...';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 1000);
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Recherche en temps réel
    const searchInput = document.getElementById('search');
    let searchTimeout;
    
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        if (e.target.value.length > 2 || e.target.value.length === 0) {
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 800);
        }
    });
    
    // Animation des cartes
    const personnelCards = document.querySelectorAll('.personnel-card');
    personnelCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150);
    });
    
    // Initialisation du graphique des corps
    initCorpsChart();
});
    
    // Animation des barres de progression
    const progressBars = document.querySelectorAll('.progress-fill');
    setTimeout(() => {
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }, 1000);
    
    // Animation des lignes du tableau
    const tableRows = document.querySelectorAll('#personnel-tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';
        setTimeout(() => {
            row.style.transition = 'all 0.4s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateX(0)';
        }, (index * 50) + 800);
    });
    
    // Initialisation du graphique des corps
    initCorpsChart();
});

function initCorpsChart() {
    const ctx = document.getElementById('corpsChart');
    if (!ctx) return;
    
    // Vérifier si Chart.js est disponible
    if (typeof Chart === 'undefined') {
        console.log('Chart.js non disponible, chargement depuis CDN...');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = function() {
            createChart();
        };
        document.head.appendChild(script);
    } else {
        createChart();
    }
    
    function createChart() {
        const ctxChart = ctx.getContext('2d');
        
        // Données du graphique
        const corpsData = [
            {% for corps in stats.par_corps %}
            {
                label: '{{ corps.corps }}',
                value: {{ corps.count }},
                color: 'hsl({{ loop.index0 * 45 % 360 }}, 70%, 60%)'
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Configuration Chart.js
        new Chart(ctxChart, {
            type: 'doughnut',
            data: {
                labels: corpsData.map(d => d.label),
                datasets: [{
                    data: corpsData.map(d => d.value),
                    backgroundColor: corpsData.map(d => d.color),
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
}
});

// Raccourcis clavier
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('search').focus();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        resetFilters();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        exportPersonnel();
    }
});
</script>
{% endblock %}
